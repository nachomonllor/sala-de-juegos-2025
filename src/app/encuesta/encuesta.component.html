<mat-card class="encuesta-card">
  <mat-card-header>
    <mat-card-title>Encuesta de Opinión</mat-card-title>
    <mat-card-subtitle>Dame un feedback para mejorar la sala de juegos</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <!-- Estado de carga -->
    <div *ngIf="cargando()" class="loading">
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      <p>Cargando encuesta...</p>
    </div>

    <!-- Error -->
    <div *ngIf="!cargando() && error()" class="error-banner">
      <mat-icon color="warn">error</mat-icon>
      <span>{{ error() }}</span>
    </div>

    <!-- Formulario -->
    <form [formGroup]="form" *ngIf="!cargando() && !error()">
      <!-- DATOS PERSONALES -->
      <div class="grid">
        <mat-form-field class="full" appearance="outline">
          <mat-label>Nombre y apellido</mat-label>
          <input matInput formControlName="nombreApellido" placeholder="Juan Pérez">
          <mat-error *ngIf="form.get('nombreApellido')?.hasError('required')">Obligatorio</mat-error>
          <mat-error *ngIf="form.get('nombreApellido')?.hasError('pattern')">
            Solo letras y espacios.
          </mat-error>
        </mat-form-field>

        <mat-form-field class="half" appearance="outline">
          <mat-label>Edad</mat-label>
          <input matInput type="number" formControlName="edad" placeholder="25" min="19" max="98">
          <mat-error *ngIf="form.get('edad')?.hasError('required')">Obligatoria</mat-error>
          <mat-error *ngIf="form.get('edad')?.hasError('min') || form.get('edad')?.hasError('max')">
            Debe ser entre 19 y 98 años.
          </mat-error>
        </mat-form-field>

        <mat-form-field class="half" appearance="outline">
          <mat-label>Teléfono</mat-label>
          <input matInput formControlName="telefono" inputmode="numeric" maxlength="10" placeholder="1122334455">
          <mat-hint align="end">{{ form.value.telefono?.length || 0 }}/10</mat-hint>
          <mat-error *ngIf="form.get('telefono')?.hasError('required')">Obligatorio</mat-error>
          <mat-error *ngIf="form.get('telefono')?.hasError('pattern')">
            Solo números (hasta 10 dígitos).
          </mat-error>
        </mat-form-field>
      </div>

      <mat-divider class="sp-24"></mat-divider>

      <!-- PREGUNTAS DINÁMICAS -->
      <ng-container *ngFor="let pregunta of preguntas(); let i = index">
        <section class="section" *ngIf="pregunta.tipo_control === 'radio'">
          <h3 class="section-title">{{ pregunta.texto }}<span *ngIf="pregunta.es_requerida">*</span></h3>
          <mat-radio-group [formControlName]="'pregunta_' + pregunta.id" class="radios">
            <mat-radio-button *ngFor="let opcion of pregunta.opciones" [value]="opcion.valor">
              {{ opcion.texto }}
            </mat-radio-button>
          </mat-radio-group>
          <div class="err" *ngIf="getPreguntaFormControl(pregunta.id).touched && getPreguntaFormControl(pregunta.id).invalid">
            <mat-icon inline>error</mat-icon> Esta pregunta es obligatoria.
          </div>
        </section>

        <section class="section" *ngIf="pregunta.tipo_control === 'checkbox'">
          <h3 class="section-title">{{ pregunta.texto }}<span *ngIf="pregunta.es_requerida">*</span></h3>
          <div [formArrayName]="'pregunta_' + pregunta.id" class="checks">
            <mat-checkbox *ngFor="let opcion of pregunta.opciones; let j = index" [formControlName]="j">
              {{ opcion.texto }}
            </mat-checkbox>
          </div>
          <div class="err" *ngIf="getPreguntaFormArray(pregunta.id).touched && getPreguntaFormArray(pregunta.id).invalid">
            <mat-icon inline>error</mat-icon> Marcá al menos una opción.
          </div>
        </section>

        <mat-form-field class="full" appearance="outline" *ngIf="pregunta.tipo_control === 'textbox'">
          <mat-label>{{ pregunta.texto }}<span *ngIf="pregunta.es_requerida">*</span></mat-label>
          <textarea 
            matInput 
            [formControlName]="'pregunta_' + pregunta.id" 
            rows="4" 
            maxlength="500"
            [placeholder]="'Escribí tu respuesta aquí...'">
          </textarea>
          <mat-hint align="end">{{ getPreguntaFormControl(pregunta.id).value?.length || 0 }}/500</mat-hint>
          <mat-error *ngIf="getPreguntaFormControl(pregunta.id).hasError('required')">Obligatorio</mat-error>
          <mat-error *ngIf="getPreguntaFormControl(pregunta.id).hasError('minlength')">Demasiado corto (mínimo 10 caracteres).</mat-error>
        </mat-form-field>

        <mat-divider class="sp-24" *ngIf="i < preguntas().length - 1"></mat-divider>
      </ng-container>
    </form>
  </mat-card-content>

  <mat-card-actions align="end" *ngIf="!cargando() && !error()">
    <button mat-stroked-button color="primary" type="button" (click)="form.reset(); construirFormulario(preguntas())">Limpiar</button>
    <button mat-raised-button color="accent" type="submit" [disabled]="form.invalid || enviando" (click)="onSubmit()">
      <mat-icon *ngIf="!enviando">send</mat-icon>
      <mat-icon *ngIf="enviando">hourglass_empty</mat-icon>
      {{ enviando ? 'Enviando…' : 'Enviar encuesta' }}
    </button>
  </mat-card-actions>
</mat-card>






<!-- 
<section class="encuesta-container">
  <h2>Encuesta de Opinión</h2>
  <form [formGroup]="encuestaForm" (ngSubmit)="onSubmit()">

    NOMBRE 
    <div class="form-group">
      <label for="nombre">Nombre y Apellido:</label>
      <input id="nombre" formControlName="nombre" type="text" placeholder="Juan" />
      <div class="error" *ngIf="encuestaForm.get('nombre')?.touched && encuestaForm.get('nombre')?.invalid">
        <small *ngIf="encuestaForm.get('nombre')?.errors?.['required']">El nombre es obligatorio.</small>
        <small *ngIf="encuestaForm.get('nombre')?.errors?.['pattern']">Solo letras y espacios.</small>
      </div>
    </div>

     APELLIDO 
    <div class="form-group">
      <label for="apellido">Apellido:</label>
      <input id="apellido" formControlName="apellido" type="text" placeholder="Pérez" />
      <div class="error" *ngIf="encuestaForm.get('apellido')?.touched && encuestaForm.get('apellido')?.invalid">
        <small *ngIf="encuestaForm.get('apellido')?.errors?.['required']">El apellido es obligatorio.</small>
        <small *ngIf="encuestaForm.get('apellido')?.errors?.['pattern']">Solo letras y espacios.</small>
      </div>
    </div>

    EDAD
    <div class="form-group">
      <label for="edad">Edad:</label>
      <input id="edad" formControlName="edad" type="number" placeholder="Ej: 25" min="19" max="98" />
      <div class="error" *ngIf="encuestaForm.get('edad')?.touched && encuestaForm.get('edad')?.invalid">
        <small *ngIf="encuestaForm.get('edad')?.errors?.['required']">La edad es obligatoria.</small>
        <small *ngIf="encuestaForm.get('edad')?.errors?.['min'] || encuestaForm.get('edad')?.errors?.['max']">
          Debe ser entre 19 y 98 años.
        </small>
      </div>
    </div>

     TELÉFONO 
    <div class="form-group">
      <label for="telefono">Teléfono:</label>
      <input id="telefono" formControlName="telefono" type="text" placeholder="Ej: 1122334455" maxlength="10" />
      <div class="error" *ngIf="encuestaForm.get('telefono')?.touched && encuestaForm.get('telefono')?.invalid">
        <small *ngIf="encuestaForm.get('telefono')?.errors?.['required']">El teléfono es obligatorio.</small>
        <small *ngIf="encuestaForm.get('telefono')?.errors?.['pattern']">Solo números (hasta 10 dígitos).</small>
      </div>
    </div>

    <hr />

    PREGUNTA 1: TEXTO 
    <div class="form-group">
      <label for="preguntaTexto">1. ¿Cuál es tu comida favorita?</label>
      <input id="preguntaTexto" formControlName="preguntaTexto" type="text" placeholder="Escribe tu respuesta" />
      <div class="error"
        *ngIf="encuestaForm.get('preguntaTexto')?.touched && encuestaForm.get('preguntaTexto')?.invalid">
        <small *ngIf="encuestaForm.get('preguntaTexto')?.errors?.['required']">Respuesta obligatoria.</small>
      </div>
    </div>

     PREGUNTA 2: RADIO BUTTON 
    <div class="form-group">
      <label>2. ¿Qué color prefieres?</label>
      <div *ngFor="let opcion of opcionesRadio">
        <input type="radio" [value]="opcion" formControlName="preguntaRadio" [id]="opcion" />
        <label [for]="opcion">{{ opcion }}</label>
      </div>
      <div class="error"
        *ngIf="encuestaForm.get('preguntaRadio')?.touched && encuestaForm.get('preguntaRadio')?.invalid">
        <small *ngIf="encuestaForm.get('preguntaRadio')?.errors?.['required']">Debes seleccionar un color.</small>
      </div>
    </div>

    PREGUNTA 3: CHECKBOX 
    <div class="form-group">
      <label>3. ¿Qué redes sociales usas? (marca al menos una)</label>
      <div formArrayName="preguntaCheckbox">
        <div *ngFor="let opcion of opcionesCheck; let i = index">
          <input type="checkbox" [formControlName]="i" [id]="'chk' + i" />
          <label [for]="'chk' + i">{{ opcion }}</label>
        </div>
      </div>
      <div class="error" *ngIf="preguntaCheckboxArray.touched && preguntaCheckboxArray.invalid">
        <small *ngIf="preguntaCheckboxArray.errors?.['minCheckbox']">Marca al menos una opción.</small>
      </div>
    </div>

    <hr />

     BOTÓN DE ENVÍO 
    <button type="submit">Enviar Encuesta</button>
  </form>
</section>
 -->